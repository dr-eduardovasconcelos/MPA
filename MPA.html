<!DOCTYPE html>

<!--
    This file is part of Markovian Processes Analyst (MPA).
    MPA is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.
    MPA is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
    You should have received a copy of the GNU General Public License
    along with MPA.  If not, see <https://www.gnu.org/licenses/>.
-->
<html>
<head>
    <title>MPA</title>
    <script src="assets/jquery-3.6.0.slim.min.js"></script>
    <script src="assets/vis-network.min.js"></script>
    <link rel="stylesheet" href="assets/bootstrap.min.css">
    <script src="assets/bootstrap.min.js"></script>
    <link rel="stylesheet" href="assets/bootstrap-theme.min.css">
    <script src="assets/CTMCMTTF.js"></script>
    <style>
    
        #modelPanel {
            position: relative;
            width: 100%;
            height: 70%;
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <div class="">
        <div class="mt-4 p-5 bg-secondary text-white rounded">
            <h3>Markovian Processes Analyst</h3> 
            <p>Improve your business processes analyses</p> 
        </div>
    </div>
    <div>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalCreateActivity">Create
            one Activity</button>
        <button type="button" class="btn btn-link pull-right" data-toggle="modal" data-target="#modalHelp">Help-me</button>
    </div>
    <div id="modelPanel"></div>

    <div class="modal fade" id="modalCreateActivity" tabindex="-1" role="dialog" aria-labelledby="insert an activity"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inseranactivity">Activity Informaion</h5>
                    
                </div>
                <div class="modal-body">
                    <form>
                        <div class="input-group mb-3" style="width: 100%;">
                            <label for="actLabel">Activity label:</label><br />
                            <input id="actLabel" type="text" class="form-control" placeholder="Activity Label"
                                   aria-label="Activity label" aria-describedby="basic-addon2" />
                        </div>
                        <div class="input-group mb-3">
                            <label for="actSTime">Activity period per time unit:</label><br />
                            <input id="actSTime" type="text" class="form-control" placeholder="Activity period"
                                aria-label="Activity period" aria-describedby="basic-addon2" />
                            <div style="color: blue;"><small>type a number > 0! the time unit can be seconds, minutes,
                                    days, etc. Once you decide which unit to use, make sure that the other activities
                                    have the same unit
                                </small></div>
                        </div>
                        <div class="input-group mb-3" style="width: 100%">
                            <label for="actCost">Activity cost per time unit:</label><br />
                            <input id="actCost" type="text" class="form-control" placeholder="Activity cost"
                                aria-label="Activity cost" aria-describedby="basic-addon2" />
                            <div style="color: blue;"><small>type a number > 0!
                                </small></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="btnCreateActivity" class="btn btn-primary"
                        data-dismiss="modal">Create</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalActivityInfo" tabindex="-1" role="dialog" aria-labelledby="Activity information"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="Activityinformation">Activity informaion</h4>
                    
                </div>
                <div class="modal-body" id="actInfoBody">
                    <h5 class="modal-title" id="Activityinformation">Activity Parameters</h5>
                    <table id="tblActInfo" class="table">

                    </table>
                    <button id="btnPModalUpdateActivity" type="button" class="btn btn-primary"
                            >update this activity</button>
                    <button id="btnDeleteActivity" type="button" class="btn btn-primary"
                            data-dismiss="modal">delete this activity</button>
                </div>
                <div class="modal-body" id="edgesInfoBody">
                    <h5 class="modal-title" id="Activityinformation">Activity Transitions</h5>
                    <table id="tblEdgInfo" class="table">

                    </table>

                    <button type="button" id="btnInsertTransition" trId="" class="btn btn-link" data-toggle="modal"
                        data-target="#modalCreateTransition">Insert one transition</button>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCreateTransition" tabindex="-1" role="dialog" aria-labelledby="insert atransition"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="insertatransition">Insert a Transition</h5>
                    
                </div>
                <div class="modal-body">
                    <form>
                        <div class="input-group mb-3" style="width: 100%;">
                            <label for="toID">To:</label><br />
                            <select id="toID" class="form-control" placeholder="Activity id" aria-label="Activity Id"
                                aria-describedby="basic-addon2">

                            </select>
                        </div>
                        <div class="input-group mb-3">
                            <label for="trWeigth">Transition weight:</label><br />
                            <input id="trWeigth" type="text" class="form-control" placeholder="weight"
                                aria-label="weight" aria-describedby="basic-addon2">
                            <div style="color: blue;"><small>
                                    This value represents the proportion of times or the probability of this transition
                                    occurs.
                                </small></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="btnCreateTransition" class="btn btn-primary"
                        data-dismiss="modal">Create</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modalUpdateActivity" tabindex="-1" role="dialog" aria-labelledby="insert an activity"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateanactivity">Activity Informaion</h5>
                    
                </div>
                <div class="modal-body">
                    <form>
                        <input type="hidden" id="updateActivityHidden"/>
                        <div class="input-group mb-3" style="width: 100%;">
                            <label for="actLabelUpdate">Activity label:</label><br />
                            <input id="actLabelUpdate" type="text" class="form-control" placeholder="Activity Label"
                                   aria-label="Activity label" aria-describedby="basic-addon2" />
                        </div>
                        <div class="input-group mb-3">
                            <label for="actSTimeUpdate">Activity period per time unit:</label><br />
                            <input id="actSTimeUpdate" type="text" class="form-control" placeholder="Activity period"
                                aria-label="Activity period" aria-describedby="basic-addon2" />
                            <div style="color: blue;"><small>type a number > 0! the time unit can be seconds, minutes,
                                    days, etc. Once you decide which unit to use, make sure that the other activities
                                    have the same unit
                                </small></div>
                        </div>
                        <div class="input-group mb-3" style="width: 100%">
                            <label for="actCostUpdate">Activity cost per time unit:</label><br />
                            <input id="actCostUpdate" type="text" class="form-control" placeholder="Activity cost"
                                aria-label="Activity cost" aria-describedby="basic-addon2" />
                            <div style="color: blue;"><small>type a number > 0!
                                </small></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="btnUpdateActivity" class="btn btn-primary"
                        data-dismiss="modal">Update</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modalTransitionInfo" tabindex="-1" role="dialog" aria-labelledby="Activity information"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="TransitionInfo">Transition info</h4>
                    
                </div>
                <div class="modal-body" id="actInfoBody">
                    <h5 class="modal-title" id="Activityinformation">Parameters</h5>
                    <table id="tblTrInfo" class="table">

                    </table>
                    <button id="btnPModalUpdateTransition" type="button" class="btn btn-primary"
                            >update transition's weight</button>
                    <button id="btnDeleteTransition" type="button" data-dismiss="modal" class="btn btn-primary"
                            >Delete this transition</button>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modalUpdateTransition" tabindex="-1" role="dialog" aria-labelledby="insert atransition"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateatransition">Transition Update</h5>
                    
                </div>
                <div class="modal-body">
                    <form>
                        <div class="input-group mb-3">
                            <label for="trUpWeight">transition Weight:</label><br />
                            <input id="trUpWeight" type="text" class="form-control" placeholder="weight"
                                aria-label="weight" aria-describedby="basic-addon2">
                            <div style="color: blue;"><small>
                                    This value represents the proportion of times or the probability of this transition
                                    occurs.
                                </small></div>
                            </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="btnUpdateTransition" class="btn btn-primary"
                        data-dismiss="modal">Update</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalGnrJSON" tabindex="-1" role="dialog" aria-labelledby="copy JSON"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header" >
                    <h5 class="modal-title" id="gnrJsonInfo">Model JSON</h5>
                    
                </div>
                <div class="modal-body">
                    <textarea class="form-control" id="txtAreaGnrJSON" rows="6"></textarea>
                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-primary" id="btnCopyJSON" data-dismiss="modal">copy JSON</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalLoadJSON" tabindex="-1" role="dialog" aria-labelledby="load JSON"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header" >
                    <h5 class="modal-title" id="loadJsonInfo">Load a JSON</h5>
                    
                </div>
                <div class="modal-body">
                    <textarea class="form-control" id="txtAreaLoadJSON" rows="6"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="btnLoadJSON" data-dismiss="modal">Load Model</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalResult" tabindex="-1" role="dialog" aria-labelledby="load JSON"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header" >
                    <h4 class="modal-title" id="loadJsonInfo">Results</h4>
                    
                </div>
                <div class="modal-body">
                    <div class="panel">
                        <table class="table">
                            <tr>
                                <td>
                                    <p class="h4">Mean Time to Finish:</p>
                                    <p class="h5" id="MTTFInfo"></p>
                                </td>
                                <td>
                                    <p class="h4">Process Cost:</p>
                                    <p class="h5" id="processCostInfo"></p>
                                </td>
                            </tr>
                        </table>

                    </div>
                    <div class="panel"> 
                        <p class="h4">Activities Info</p>
                        <table id="tblActRes" class="table">
                            
                        </table>
                    </div>
                    <div class="panel">
                        <p class="h4">Absortion Probs</p>
                        <table id="tblAbsRes" class="table">
                            
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalHelp" tabindex="-1" role="dialog" aria-labelledby="load JSON"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header" >
                    <h5 class="modal-title" >Help</h5>
                    
                </div>
                <div class="modal-body" style="font-size: 9pt;">
                    <ul>
                        <li>
                            To create one activity, you can click on the button "Create one Activity", located on the top-left of this page. 
                            You can also double-click on the work area to create one activity.
                        </li>
                        <li>
                            Each activity has three attributes: a label, a period, and the cost per time unit. The period is the meantime 
                            to conclude this activity and you have to decide which time unit is used. Example: days, hours, minutes.
                        </li>
                        <li>
                            Cost attribute refers to the monetary cost spent, per time unit, to execute one activity.
                        </li>
                        <li>
                            The only obligatory attribute is the label. If you let the other fields empty, the system will assign the value 1.
                        </li>
                        <li>
                            If you double-click over one activity, a pop-up will appear with the information of this particular activity. 
                            From this pop-up, you can update the attributes, delete this activity and create transitions.
                        </li>
                        <li>
                            To create one transition between two activities, double-click one activity and click on the link "insert one transition". 
                            One pop-up will appear and you will be able to select other activities. Each transition has a weight. This weight represents the probability
                            this transition occurs. Let's consider that we have three activities {1,2,3}. let's consider that the transitions 1->2 and 1->3 have weights 
                            10 and 20 respectively. Once the process is on activity 1, the probability of it going to activity 2 is 10/(10+20)=0.3333.
                            If you let the weight field empty, the system will assign 1.
                        </li>
                        <li>
                            The activities have three colors: coral, blue and gray. The coral color is always assigned to the initial activity, the blue color is assigned
                            to regular activities and grey to absorption activities. (absorption activities are those who have not leaving transitions)
                        </li>
                        <li>
                            To perform an analysis, some conditions must be satisfied: (i) you need to define an initial activity. The system always assigns this role to 
                            the first activity. If you delete this activity, the second will be assigned as the initial activity and so on. (ii) you need to have at least 
                            one absorption activity. (iii) every activity needs to be reachable, except the initial activity. It means that each activity needs to have at 
                            last one arriving transition.
                        </li>
                        <li>
                            This page does not use cookies or any kind of storage. To save your models, you need to click on the link "generate JSON" and copy the text 
                            inside the textarea. Save this text wherever you want. To load your model, just click on the link "Load Model from JSON" and paste the text
                            into the textarea box.
                        </li>
                        <li>
                            You can also save an image of your model. To do this, just right-click the work area and select the item, "save image as..." 
                            The image will be saved as png.
                        </li>
                    </ul>
                    This page has been developed by dr. Eduardo M. Vasconcelos. If you have any questions about this page, please, contact me.<br/>
                    <small>eduardo.vasconcelos@recife.ifpe.edu.br</small>
                </div>
                <div class="modal-footer">
                    
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-body">
            <div class="" >
                <div class="d-flex row">
                    <button type="button" id="btnPerfAnalysis" class="btn btn-primary"
                       >Perform Analysis</button>
                    <div  class="pull-right" style="width: fit-content;">
                        <button type="button" id="btnGnrJSON" class="btn btn-link"  data-toggle="modal" data-target="#modalGnrJSON"
                            >Generate JSON</button>
                        <button type="button"  class="btn btn-link" data-toggle="modal" data-target="#modalLoadJSON"
                            >Load Model from JSON</button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <script>

        var container = document.getElementById("modelPanel")
        var options = {
            layout: { randomSeed: 2 } 
        }
        var network

        var nodes = []
        var edges = []
        var lastNode = 1

        var boardNodes
        var boardEdges
        
        network = new vis.Network(container, {}, options)
        network.on("doubleClick", function(){
            $("#modalCreateActivity").modal("show")
                return
        })
        
        function restartBoard(){
            
            network.destroy()
            network = null
            
            boardNodes = new vis.DataSet(nodes)
            boardEdges = new vis.DataSet(edges)

            const data = { nodes: boardNodes, edges: boardEdges }

            network = new vis.Network(container, data, options)

            network.on("doubleClick", onNetwork)
        }
        

        /*
         * 
         * @returns {undefined}
         * Este método é usado no evento que cria uma atividade
         */
        let createActivity = function () {

            let label = document.forms[0].getElementsByTagName("input")[0].value
            let isLabelExistent = false
            let time = document.forms[0].getElementsByTagName("input")[1].value
            let cost = document.forms[0].getElementsByTagName("input")[2].value

            nodes.forEach((element) => {
                if (element.label.split(":")[1] === label) {
                    alert(`the label ${label} is already been used in another activity`)
                    document.forms[0].getElementsByTagName("input")[0].value = ""
                    isLabelExistent = true
                    return
                }
            })

            if (isLabelExistent) {
                return
            }

            if (time == "") {
                time = 1
            }

            if (cost == "") {
                cost = 1
            }

            if (isNaN(time)) {
                alert("type a number on activity duration field")

                document.forms[0].getElementsByTagName("input")[1].value = ""
                return;
            }

            if (isNaN(cost)) {
                alert("type a number on activity cost field")

                document.forms[0].getElementsByTagName("input")[2].value = ""
                return
            }

            time = parseFloat(time)
            cost = parseFloat(cost)

            if (time <= 0) {
                alert("type a period > 0")
                document.forms[0].getElementsByTagName("input")[1].value = ""
                return
            }

            if (cost <= 0) {
                alert("type a cost > 0")
                document.forms[0].getElementsByTagName("input")[2].value = ""
                return
            }

            document.forms[0].getElementsByTagName("input")[0].value = ""
            document.forms[0].getElementsByTagName("input")[1].value = ""
            document.forms[0].getElementsByTagName("input")[2].value = ""
            
            if(lastNode!=1){
                nodes.push({
                    id: lastNode++,
                    label: `#${lastNode - 1}:${label}`,
                    activityLabel: label,
                    time: time,
                    cost: cost,
                    transitions: [],
                    color: "#dddddd"
                })
            }else{
                nodes.push({
                    id: lastNode++,
                    label: `#${lastNode - 1}:${label}`,
                    activityLabel: label,
                    time: time,
                    cost: cost,
                    transitions: [],
                    color: "#dda0a0"
                })
            }

            restartBoard()

        }


        document.getElementById("btnCreateActivity").addEventListener("click", createActivity)
        
        /*
         * 
         * @returns {undefined}
         * Método usado para alterar as informações de uma atividade
         */
        let updateActivity = function(){
            
            const conf = confirm("Are you sure you want to update this activity?")
            
            if(!conf){
                return
            }
            
            const updateForm = document.forms[2]
            
            const id = updateForm.getElementsByTagName("input")[0].value
            let label = updateForm.getElementsByTagName("input")[1].value
            let time = updateForm.getElementsByTagName("input")[2].value
            let cost = updateForm.getElementsByTagName("input")[3].value
            
            if(isNaN(time)){
                alert("type a number on activity duration field")
                return
            }
            
            if(time === ""){
                time = 1
            }
            
            if(isNaN(cost)){
                alert("type a number on cost field")
                return
            }

            time = parseFloat(time)
            cost = parseFloat(cost)

            if (time <= 0) {
                alert("type a period > 0")
                document.forms[0].getElementsByTagName("input")[1].value = ""
                return
            }

            if (cost <= 0) {
                alert("type a cost > 0")
                document.forms[0].getElementsByTagName("input")[2].value = ""
                return
            }
            
            if(cost === ""){
                cost = 1
            }
            
            const node = nodes[id-1]
            
            node.activityLabel = label
            node.label = `#${id}:${label}`
            node.time = time
            node.cost = cost
            
            restartBoard()
            
            $("#modalActivityInfo").modal("hide")
            
        }
        
        document.getElementById("btnUpdateActivity").addEventListener("click",updateActivity)
        
        /*
         * 
         * @type type
         * Este evento insere a transição entre duas atividades
         * 
         */
        document.getElementById("btnInsertTransition").addEventListener("click", function (event) {

            const selectTo = document.forms[1].getElementsByTagName("select")[0]
            const node = nodes[event.target.getAttribute("trId") - 1]

            while (selectTo.lastChild) {
                selectTo.removeChild(selectTo.firstChild)
            }

            nodes.forEach(element => {

                if (element.id !== node.id) {
                    let haveIThisTransition = false
                    for (let i = 0; i < node.transitions.length; i++) {
                        if (element.id === node.transitions[i].to) {
                            haveIThisTransition = true
                            break
                        }
                    }
                    if (haveIThisTransition === false) {
                        const opt = document.createElement("option")
                        opt.setAttribute("value", element.id)
                        opt.appendChild(document.createTextNode(element.label))
                        selectTo.appendChild(opt)
                    }
                }

            })

        })


        /*
         * 
         * @returns {undefined}
         * Este método é usado no evento do click que abre o modal de criação das transições
         * é ele quem prepara o select com as atividades disponíveis
         * 
         */
        const createTransition = function () {
            const selectTo = document.forms[1].getElementsByTagName("select")[0]
            if (selectTo.value == "") {
                alert("You need to select an activity to create a transition")
                return
            }
            const node = nodes[document.getElementById("btnInsertTransition").getAttribute("trId") - 1]
            const nodeTo = nodes[parseInt(selectTo.value) - 1]

            let w = document.forms[1].getElementsByTagName("input")[0].value

            if (w === "") {
                w = 1
            }

            if (isNaN(w) || w <= 0) {
                alert("the weight needs to be a number greater than 0")
                document.forms[1].getElementsByTagName("input")[0].value = ""
                return
            }

            node.transitions.push({ to: nodeTo.id, weight: parseFloat(w) })
            
            if(node.id!=1)
                delete node.color

            edges.push({from: node.id, 
                to: nodeTo.id, 
                label: w+"",
                arrows: {
                    to: {
                        enabled: true,
                        type: "arrow",
                    }
                }
            })
            
            document.forms[1].getElementsByTagName("input")[0].value = ""

            restartBoard()

            $("#modalActivityInfo").modal("hide")

        }


        /*
         * 
         * @param {type} param
         * @returns {undefined}
         * 
         * Este método é usado para criar o evento do click duplo na área de trabalho
         */
        let onNetwork = function (param) {
            /*
             * se o click duplo for feito no fundo da área de trabalho, abre o modal para criar uma atividade
             */
            if (param.nodes.length === 0 && param.edges.length === 0) {
                $("#modalCreateActivity").modal("show")
                return
            }
            
            /*
             * O código abaixo é executado sempre que uma transição for clicada
             */
            if(param.edges.length > 0 && param.nodes.length === 0){
                
                const edgId = param.edges[0]
                
                let edge
                let i = 0
                
                for(i = 0; i < edges.length; i++){
                    if(edges[i].id == edgId){
                        edge = edges[i]
                        break
                    }
                }
                
                const trTbl = document.getElementById("tblTrInfo")
                
                while (trTbl.firstChild) {
                    trTbl.removeChild(trTbl.lastChild);
                }
                
                const firstTR = document.createElement("tr")
                const firstTDLabel = document.createElement("th")
                firstTDLabel.appendChild(document.createTextNode("From Activity"))
                const firstTDValue = document.createElement("td")
                firstTDValue.appendChild(document.createTextNode(nodes[edge.from - 1].label))
                firstTR.appendChild(firstTDLabel)
                firstTR.appendChild(firstTDValue)
                trTbl.appendChild(firstTR)


                const secondTR = document.createElement("tr")
                const secondTDLabel = document.createElement("th")
                secondTDLabel.appendChild(document.createTextNode("To Activity:"))
                const secondTDValue = document.createElement("td")
                secondTDValue.appendChild(document.createTextNode(nodes[edge.to - 1].label))
                secondTR.appendChild(secondTDLabel)
                secondTR.appendChild(secondTDValue)
                trTbl.appendChild(secondTR)
                
                let weight = 0
                
                nodes[edge.from - 1].transitions.forEach(element => {
                    if(element.to == edge.to){
                        weight = element.weight
                    }
                })

                const thirdTR = document.createElement("tr")
                const thirdTDLabel = document.createElement("th")
                thirdTDLabel.appendChild(document.createTextNode("Weight:"))
                const thirdTDValue = document.createElement("td")
                thirdTDValue.appendChild(document.createTextNode(weight))
                thirdTR.appendChild(thirdTDLabel)
                thirdTR.appendChild(thirdTDValue)
                trTbl.appendChild(thirdTR)
                
                document.getElementById("btnPModalUpdateTransition").setAttribute("edgIndex",i)
                document.getElementById("btnPModalUpdateTransition").addEventListener("click", function(event){
                    
                    const edge = edges[event.target.getAttribute("edgIndex")]
                    
                    const nodeFrom = nodes[edge.from - 1]
                    
                    let index = 0
                    for(index = 0; index < nodeFrom.transitions.length; index++){
                        if(nodeFrom.transitions[index].to == edge.to){
                            document.getElementById("trUpWeight").value = nodeFrom.transitions[index].weight
                            break
                        }
                    }
                    
                    document.getElementById("btnUpdateTransition").setAttribute("actId",nodeFrom.id)
                    document.getElementById("btnUpdateTransition").setAttribute("trIndex", index)
                    document.getElementById("btnUpdateTransition").setAttribute("edgIndex", event.target.getAttribute("edgIndex"))
                    document.getElementById("btnUpdateTransition").addEventListener("click",updateTransition)
                    
                    $("#modalUpdateTransition").modal("show")
                })
                
                document.getElementById("btnDeleteTransition").setAttribute("fromId",edge.from)
                document.getElementById("btnDeleteTransition").setAttribute("ToId",edge.to)
                document.getElementById("btnDeleteTransition").addEventListener("click",deleteTransition)
                
                $("#modalTransitionInfo").modal("show")
                
                return
            }
            
            /*
             * 
             * @type Element
             * O código abaixo é executado sempre que uma atividade é clicada
             */

            const mainTable = document.getElementById("tblActInfo")

            while (mainTable.firstChild) {
                mainTable.removeChild(mainTable.lastChild);
            }

            const node = nodes[param.nodes[0] - 1]
            
            document.getElementById("Activityinformation").innerHTML = `Activity <b><i>${node.label}</i></b> Info:`

            const firstTR = document.createElement("tr")
            const firstTDLabel = document.createElement("th")
            firstTDLabel.appendChild(document.createTextNode("Activity Id"))
            const firstTDValue = document.createElement("td")
            firstTDValue.appendChild(document.createTextNode(node.id))
            firstTR.appendChild(firstTDLabel)
            firstTR.appendChild(firstTDValue)
            mainTable.appendChild(firstTR)


            const secondTR = document.createElement("tr")
            const secondTDLabel = document.createElement("th")
            secondTDLabel.appendChild(document.createTextNode("Activity Label:"))
            const secondTDValue = document.createElement("td")
            secondTDValue.appendChild(document.createTextNode(node.label.split(":")[1]))
            secondTR.appendChild(secondTDLabel)
            secondTR.appendChild(secondTDValue)
            mainTable.appendChild(secondTR)

            const thirdTR = document.createElement("tr")
            const thirdTDLabel = document.createElement("th")
            thirdTDLabel.appendChild(document.createTextNode("Activity Period:"))
            const thirdTDValue = document.createElement("td")
            thirdTDValue.appendChild(document.createTextNode(node.time))
            thirdTR.appendChild(thirdTDLabel)
            thirdTR.appendChild(thirdTDValue)
            mainTable.appendChild(thirdTR)

            const forthTR = document.createElement("tr")
            const forthTDLabel = document.createElement("th")
            forthTDLabel.appendChild(document.createTextNode("Activity Cost"))
            const forthTDValue = document.createElement("td")
            forthTDValue.appendChild(document.createTextNode(node.cost))
            forthTR.appendChild(forthTDLabel)
            forthTR.appendChild(forthTDValue)
            mainTable.appendChild(forthTR)

            const edgTable = document.getElementById("tblEdgInfo")

            while (edgTable.firstChild) {
                edgTable.removeChild(edgTable.lastChild);
            }

            if (node.transitions.length === 0) {
                edgTable.append(document.createTextNode("This activity has no transitions"))
            } else {

                const firstTR = document.createElement("tr")
                const firstTDTo = document.createElement("th")
                firstTDTo.appendChild(document.createTextNode("to-ID"))
                firstTR.appendChild(firstTDTo)
                const firstTDToLabel = document.createElement("th")
                firstTDToLabel.appendChild(document.createTextNode("to-label"))
                firstTR.appendChild(firstTDToLabel)
                const firstTDWeight = document.createElement("th")
                firstTDWeight.appendChild(document.createTextNode("weight"))
                firstTR.appendChild(firstTDWeight)
                edgTable.appendChild(firstTR)
                const firstTDOps = document.createElement("th")
                firstTDOps.appendChild(document.createTextNode("operation"))
                firstTR.appendChild(firstTDOps)
                edgTable.appendChild(firstTR)

                node.transitions.forEach(element => {
                    const innerTR = document.createElement("tr")
                    const innerTDTo = document.createElement("td")
                    innerTDTo.appendChild(document.createTextNode(element.to))
                    innerTR.appendChild(innerTDTo)
                    
                    const innerTDToLabel = document.createElement("td")
                    innerTDToLabel.appendChild(document.createTextNode(nodes[element.to - 1].label.split(":")[1]))
                    innerTR.appendChild(innerTDToLabel)
                    
                    const innerTDWeight = document.createElement("td")
                    innerTDWeight.appendChild(document.createTextNode(element.weight))
                    innerTR.appendChild(innerTDWeight)
                    
                    const innerTDOps = document.createElement("td")
                    const deleteTransitionLink = document.createElement("button")
                    deleteTransitionLink.setAttribute("class","btn btn-link deleteTransition")
                    deleteTransitionLink.setAttribute("toId",element.to+"")
                    deleteTransitionLink.setAttribute("fromId",node.id+"")
                    deleteTransitionLink.appendChild(document.createTextNode("delete"))
                    innerTDOps.appendChild(deleteTransitionLink)
                    innerTR.appendChild(innerTDOps)
                    edgTable.appendChild(innerTR)
                    
                    $(".deleteTransition").on("click",deleteTransition)
                })
            }

            document.getElementById("btnInsertTransition").setAttribute("trId", node.id)
            document.getElementById("btnDeleteActivity").setAttribute("trId", node.id)
            const updateButton = document.getElementById("btnPModalUpdateActivity")
            updateButton.setAttribute("actId", node.id)
            updateButton.addEventListener("click", function(event){
                
                const form = document.forms[2]
                
                form.getElementsByTagName("input")[0].value = node.id
                form.getElementsByTagName("input")[1].value = node.activityLabel
                form.getElementsByTagName("input")[2].value = node.time
                form.getElementsByTagName("input")[3].value = node.cost
                
                $("#modalUpdateActivity").modal("show")
                
            })

            $("#modalActivityInfo").modal("show")
        }

        document.getElementById("btnCreateTransition").addEventListener("click", createTransition)
        
        /*
         * este código é usado para deletar uma atividade
         */
        document.getElementById("btnDeleteActivity").addEventListener("click", function(event){
            
            const node = nodes[event.target.getAttribute("trId") - 1]
            
            const conf = confirm("Are you sure that you want to delete the activity: "+node.label+"?")
            if(!conf){
                return
            }
            
            for(let i = 0; i < nodes.length; i++){
                
                if(nodes[i].id > node.id){
                    nodes[i].id--
                    nodes[i].label = `#${nodes[i].id}:${nodes[i].activityLabel}`
                }
                for(let j = 0; j < nodes[i].transitions.length; j++){
                    if(nodes[i].transitions[j].to === node.id){
                        nodes[i].transitions.splice(j,1)
                        j--
                    }else if(nodes[i].transitions[j].to > node.id){
                        nodes[i].transitions[j].to--
                    }
                }
                
            }
            
            nodes.splice(node.id-1,1)
            
            lastNode--
            
            if(node.id == 1 && nodes.length>0){
                nodes[0].color = "#dda0a0"
            }
            
           
            for(let i = 0; i < edges.length; i++){
                if(edges[i].from === node.id || edges[i].to === node.id){
                    edges.splice(i,1)
                    i--
                    continue
                }
                if(edges[i].from>node.id)
                    edges[i].from--
                if(edges[i].to>node.id)
                    edges[i].to--
            }
            
            
            restartBoard()
            
        })
        
        /*
         * Código usado para deletar transições
         */
        let deleteTransition = function(event){
            
            const conf = confirm("Are you sure you want to delete this transition?")
            
            if(!conf)
                return
            
            const nodeTo = nodes[event.target.getAttribute("toId") - 1]
            const nodeFrom = nodes[event.target.getAttribute("fromId") -1]
            
            for(let i = 0; i < nodeFrom.transitions.length; i++){
                if(nodeFrom.transitions[i].to === nodeTo.id){
                    nodeFrom.transitions.splice(i,1)
                    break
                }
            }
            
            for(let i = 0; i < edges.length; i++){
                if(edges[i].from === nodeFrom.id && edges[i].to === nodeTo.id){
                    edges.splice(i, 1)
                    break
                }
            }
            
            if(nodeFrom.id != 1 && nodeFrom.transitions.length === 0){
                nodeFrom.color = "#dddddd"
            }
            
            $("#modalActivityInfo").modal("hide")
            $("#modalTransitionInfo").modal("hide")
            
            restartBoard()
            
        }
        
        /*
        * Código usado para atualizar os pesos das atividades
        */
        let updateTransition = function(event){
            
            const conf = confirm("Are you sure you want to update this transition?")
            
            if(!conf)
                return
            
            const node = nodes[event.target.getAttribute("actId") - 1]
            const edge = edges[event.target.getAttribute("edgindex")]
            const trIndex = event.target.getAttribute("trIndex")
            
            const newWeight = document.getElementById("trUpWeight").value
            
            node.transitions[trIndex].weight = parseFloat(newWeight)
            
            edge.label = newWeight
            
            $("#modalTransitionInfo").modal("hide")
            
            restartBoard()
            
        }

        document.getElementById("btnGnrJSON").addEventListener("click", function(){

            txtAreaJson = document.getElementById("txtAreaGnrJSON")

            txtAreaJson.value = JSON.stringify(nodes)

        })

        document.getElementById("btnLoadJSON").addEventListener("click", function(){
            let auxNodes = []
            try{
                auxNodes = JSON.parse(document.getElementById("txtAreaLoadJSON").value)

            }catch(e){
                alert("there are problems with your JSON")
                document.getElementById("txtAreaLoadJSON").value = ""

                return
            }

            nodes = auxNodes

            edges = []

            for(let i = 0; i < nodes.length; i++){

                for(let j = 0; j < nodes[i].transitions.length; j++){
                    edges.push({
                        from: nodes[i].id,
                        to: nodes[i].transitions[j].to,
                        label: nodes[i].transitions[j].weight+"",
                        arrows: {
                            to: {
                                enabled: true,
                                type: "arrow",
                            }
                        }
                    })
                }

            }

            lastNode = nodes.length + 1

            restartBoard()

        })

        document.getElementById("btnPerfAnalysis").addEventListener("click",function(event){

            const chain = []

            nodes.forEach((element, index) => {

                chain.push({
                        number: element.id,
                        isInitialState: false,
                        transitions:[]

                })

                let sumProbabilities = 0;

                for(let i = 0; i < element.transitions.length; i++){
                    sumProbabilities += element.transitions[i].weight
                }

                for(let i = 0; i < element.transitions.length; i++){
                    chain[index].transitions.push({
                        to: element.transitions[i].to,
                        rate: (1.0/element.time)*(element.transitions[i].weight/sumProbabilities)
                    })
                }

                if(element.id === 1){
                    chain[index].isInitialState = true
                }

            })

            let result

            event.target.setAttribute("enabled","false")

            try{
                result = calculateMTTF(chain)
            }catch(e){
                alert(e.message)
                return
            }finally{
                event.target.setAttribute("enabled","true")
            }

            document.getElementById("MTTFInfo").innerHTML = result.mttf.toFixed(4)

            const tblActRes = document.getElementById("tblActRes")

            while(tblActRes.firstChild){
                tblActRes.removeChild(tblActRes.lastChild)
            }

            const headerTR = document.createElement("tr")

            const headerTHId = document.createElement("th")
            headerTHId.appendChild(document.createTextNode("ID"))
            headerTR.appendChild(headerTHId)

            const headerTHLabel = document.createElement("th")
            headerTHLabel.appendChild(document.createTextNode("Label"))
            headerTR.appendChild(headerTHLabel)

            const headerThPeriod = document.createElement("th")
            headerThPeriod.appendChild(document.createTextNode("Execution Time"))
            headerTR.appendChild(headerThPeriod)

            const headerTHCost= document.createElement("th")
            headerTHCost.appendChild(document.createTextNode("Total Cost"))
            headerTR.appendChild(headerTHCost)

            tblActRes.appendChild(headerTR)

            let totalCost = 0

            result.statePeriods.forEach((element, index) =>{

                const currNode = nodes[element.number - 1]

                const innerTR = document.createElement("tr")

                const innerTDId = document.createElement("td")
                innerTDId.appendChild(document.createTextNode(currNode.id))
                innerTR.appendChild(innerTDId)

                const innerTDLabel = document.createElement("td")
                innerTDLabel.appendChild(document.createTextNode(currNode.activityLabel))
                innerTR.appendChild(innerTDLabel)

                const innerTDPeriod = document.createElement("td")
                innerTDPeriod.appendChild(document.createTextNode(element.period.toFixed(4)))
                innerTR.appendChild(innerTDPeriod)

                const innerTDCost= document.createElement("td")
                innerTDCost.appendChild(document.createTextNode((currNode.cost * element.period).toFixed(4)))
                innerTR.appendChild(innerTDCost)

                totalCost += (currNode.cost * element.period)

                tblActRes.appendChild(innerTR)
                
            })

            const tblAbsRes = document.getElementById("tblAbsRes")

            while(tblAbsRes.firstChild){
                tblAbsRes.removeChild(tblAbsRes.lastChild)
            }

            const headerTR2 = document.createElement("tr")

            const headerTHId2 = document.createElement("th")
            headerTHId2.appendChild(document.createTextNode("ID"))
            headerTR2.appendChild(headerTHId2)

            const headerTHLabel2 = document.createElement("th")
            headerTHLabel2.appendChild(document.createTextNode("Label"))
            headerTR2.appendChild(headerTHLabel2)

            const headerThPeriod2 = document.createElement("th")
            headerThPeriod2.appendChild(document.createTextNode("Occurrence Probabilities"))
            headerTR2.appendChild(headerThPeriod2)


            tblAbsRes.appendChild(headerTR2)

            result.absortionProbabilities.forEach(element => {

                const currNode = nodes[element.number - 1]

                const innerTR = document.createElement("tr")

                const innerTDId = document.createElement("td")
                innerTDId.appendChild(document.createTextNode(currNode.id))
                innerTR.appendChild(innerTDId)

                const innerTDLabel = document.createElement("td")
                innerTDLabel.appendChild(document.createTextNode(currNode.activityLabel))
                innerTR.appendChild(innerTDLabel)

                const innerTDPeriod = document.createElement("td")
                innerTDPeriod.appendChild(document.createTextNode((element.probability * 100).toFixed(4)+"%"))
                innerTR.appendChild(innerTDPeriod)

                tblAbsRes.appendChild(innerTR)
            })

            document.getElementById("processCostInfo").innerHTML = totalCost.toFixed(4)

            $("#modalResult").modal("show")

        })

        document.getElementById("btnCopyJSON").addEventListener("click", function(){

            const textJSON = JSON.stringify(nodes)

            navigator.clipboard.writeText(textJSON)

            alert("JSON Copied")

        })

    </script>
</body>

</html>